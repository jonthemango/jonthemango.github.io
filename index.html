<html>
    <head>

    </head>
    <body>
        <p>
        <p id="parkTime"></p>
        <p id="parkSide"></p>
        <p id="parkNoPark"></p>
        <p id="parkChangeOn"></p>
        <a target="_blank" id="mapsLink"></a>
        </p>
        <div>
        <button onclick="park('L')">Left (no park friday)</button>
        <button onclick="park('R')">Right (no park thursday)</button>
        </div>
    </body>
    <script>




function storeInBrowser(key, obj) {
  if (typeof key !== 'string') {
    throw new Error('Key must be a string');
  }
  try {
    const serialized = JSON.stringify(obj);
    localStorage.setItem(key, serialized);
  } catch (e) {
    console.error('Failed to store object:', e);
  }
}

function getFromBrowser(key) {
  try {
    const serialized = localStorage.getItem(key);
    return serialized ? JSON.parse(serialized) : null;
  } catch (e) {
    console.error('Failed to retrieve object:', e);
    return null;
  }
}

function getLocalDateTime() {
  const now = new Date();
  return now.toLocaleString(); // e.g., "03/08/2025, 11:42:10 PM"
}

async function getCurrentPositionAsync() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("Geolocation is not supported"));
    } else {
      navigator.geolocation.getCurrentPosition(resolve, reject);
    }
  });
}

async function getCurrentPosition() {

    const ttl = 60 * 1000
    let lastPosition = getFromBrowser('lastPositionCall')
    if (lastPosition) {
        const age = Date.now() - lastPosition.timestamp
        if (age < ttl){ 
            return lastPosition.position
        }
    }

    if ("geolocation" in navigator) {
        const position = await getCurrentPositionAsync();
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`
        let retval = {latitude, longitude, mapsLink}
        storeInBrowser('lastPositionCall', {position, timestamp: Date.now()})
        return retval
    } else {
        // Geolocation is not supported by this browser
        console.error("Geolocation is not supported by your browser.");
    }
}

async function park(side) {
    let pos = await getCurrentPosition()
    let time = getLocalDateTime()
    console.log(pos)
    storeInBrowser("lastPark", {
        pos,
        time,
        side
    })
    setTimeout(load, 100)
}


/**
 * @param {Date|string} parkedDate - Date you parked
 * @param {string|string[]} noParkingDays - Day(s) of week you must move by (e.g. "Thursday", or ["Thursday", "Friday"])
 * @param {Date|string} [currentDate=new Date()] - Current date, optional, defaults to now
 * @returns {string} - The day of the week you need to change your parking
 */
function getParkingChangeDay(parkedDate, noParkingDays, currentDate = new Date()) {
  const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

  const parked = new Date(parkedDate);
  const current = new Date(currentDate);

  const noParkDays = Array.isArray(noParkingDays) ? noParkingDays : [noParkingDays];
  const noParkDayNums = noParkDays.map(day => daysOfWeek.indexOf(day));

  if (noParkDayNums.some(d => d === -1)) {
    throw new Error("Invalid day name in noParkingDays");
  }

  let dayToCheck = parked.getDay();

  for (let i = 1; i <= 7; i++) {
    const nextDay = (dayToCheck + i) % 7;
    if (noParkDayNums.includes(nextDay)) {
      const changeDate = new Date(parked);
      changeDate.setDate(parked.getDate() + i);

      if (changeDate >= current) {
        // Return the day BEFORE the no-parking day
        const dayBefore = (nextDay + 6) % 7; // previous day (mod 7)
        return daysOfWeek[dayBefore];
      }
    }
  }

  return null;
}

function load() {
    let sideMap = {"L": "left", "R": "right"}
    let noParkMap = {"L": "Friday", "R": "Thursday"}
    let lastPark = getFromBrowser("lastPark")
    if (lastPark) {
        document.getElementById('parkTime').textContent = `Parked on: ${lastPark.time}`
        document.getElementById('parkSide').textContent = `Side: ${sideMap[lastPark.side]} (no parking on ${noParkMap[lastPark.side]})`
        let mapsHyperlink = document.getElementById('mapsLink')
        mapsHyperlink.textContent = "Find my car"
        mapsHyperlink.setAttribute('href', lastPark.pos.mapsLink)

        let changeDay = getParkingChangeDay(lastPark.time, noParkMap[lastPark.side])
        document.getElementById('parkChangeOn').textContent = `Change parking spot on ${changeDay}`
    }
}

window.addEventListener('DOMContentLoaded', () => {
    load()
})



    </script>
</html>