<!doctype html>
<html>
    <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    </head>
    <body>
<div class="card">
  <div class="card-body">
        <h5 class="card-title">Park Info</h5>
        <p class="card-text" id="parkTime"></p>
        <p class="card-test" id="parkSide"></span>
        <p class="card-text" id="parkNoPark"></p>
        <p class="card-text" id="parkChangeOn"></p>
        <a class="card-link" target="_blank" id="mapsLink"></a>
  </div>
</div>
<div class="row">
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Left</h5>
        <button type="button" class="btn btn-primary" onclick="park('L')">Left (no park friday)</button>
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Right</h5>
        <button type="button" class="btn btn-primary" onclick="park('R')">Right (no park thursday)</button>
      </div>
    </div>
  </div>
</div>

        

    </body>
    <script>




function storeInBrowser(key, obj) {
  if (typeof key !== 'string') {
    throw new Error('Key must be a string');
  }
  try {
    const serialized = JSON.stringify(obj);
    localStorage.setItem(key, serialized);
  } catch (e) {
    console.error('Failed to store object:', e);
  }
}

function getFromBrowser(key) {
  try {
    const serialized = localStorage.getItem(key);
    return serialized ? JSON.parse(serialized) : null;
  } catch (e) {
    console.error('Failed to retrieve object:', e);
    return null;
  }
}

function getLocalDateTime() {
  const now = new Date().toISOString();
  return now; // e.g., "03/08/2025, 11:42:10 PM"
}


function getLocation(callback) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(callback);
  }
}

function updateLastPosition() {
    if ("geolocation" in navigator) {
        resetLastPosition()
        getLocation((position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`
            let retval = {latitude, longitude, mapsLink}
            storeInBrowser('lastPosition', retval)
            setTimeout(loadLastPosition, 100)
        }) 
    } else {
        // Geolocation is not supported by this browser
        console.error("Geolocation is not supported by your browser.");
    }
}

async function park(side) {
    updateLastPosition()
    let time = getLocalDateTime()
    storeInBrowser("lastPark", {
        time,
        side
    })
    setTimeout(loadParkInfo, 100)
}


/**
 * Returns the next date when you need to move your car,
 * given the parked date and no-parking days of the week.
 *
 * @param {Date|string} parkedDate - Date you parked
 * @param {string|string[]} noParkingDays - Day(s) of week you must move by (e.g. "Thursday" or ["Thursday", "Friday"])
 * @param {Date|string} [currentDate=new Date()] - Current date, optional, defaults to now
 * @returns {Date|null} - The date when you need to move your car next, or null if inputs invalid
 */
function getParkingChangeDate(parkedDate, noParkingDays, currentDate = new Date()) {
  const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const months = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  const parked = new Date(parkedDate);
  const current = new Date(currentDate);

  const noParkDays = Array.isArray(noParkingDays) ? noParkingDays : [noParkingDays];
  const noParkDayNums = noParkDays.map(day => daysOfWeek.indexOf(day));

  if (noParkDayNums.some(d => d === -1)) {
    throw new Error("Invalid day name in noParkingDays");
  }

  let dayToCheck = parked.getDay();

  // Convert to full days (round down)

  for (let i = 1; i <= 14; i++) {  // look ahead up to two weeks to be safe
    const nextDay = (dayToCheck + i) % 7;
    if (noParkDayNums.includes(nextDay)) {
      const changeDate = new Date(parked);
      changeDate.setDate(parked.getDate() + i);

      // Only return a date in the future (or today)
      if (changeDate >= current) {
        // Return the day BEFORE the no-parking day â€” last day you can park
        changeDate.setDate(changeDate.getDate() - 1);
        changeDate.setHours(0,0,0,0);
        
        const dayName = daysOfWeek[changeDate.getDay()];
        const monthName = months[changeDate.getMonth()];
        const dayOfMonth = changeDate.getDate();

        const diffMs = changeDate - current;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;

        return `${dayName}, ${monthName} ${dayOfMonth}. That is ${diffDays} days from today.`;
      }
    }
  }

  return null; // no suitable day found in next 2 weeks (should not happen)
}

function loadParkInfo() {
    let sideMap = {"L": "left", "R": "right"}
    let noParkMap = {"L": "Friday", "R": "Thursday"}
    let lastPark = getFromBrowser("lastPark")
    if (lastPark) {
        document.getElementById('parkTime').textContent = `Parked on: ${lastPark.time}`
        document.getElementById('parkSide').textContent = `Side: ${sideMap[lastPark.side]} (no parking on ${noParkMap[lastPark.side]})`
        let changeDay = getParkingChangeDate(lastPark.time, noParkMap[lastPark.side])
        document.getElementById('parkChangeOn').textContent = `Change parking spot no later than ${changeDay}`
    }
}

function loadLastPosition() {
    let lastPosition = getFromBrowser("lastPosition")
    if (lastPosition) {
        let mapsHyperlink = document.getElementById('mapsLink')
        mapsHyperlink.textContent = "Find my car"
        mapsHyperlink.setAttribute('href', lastPosition.mapsLink)
    }
}

function resetLastPosition() {
    let mapsHyperlink = document.getElementById('mapsLink')
    mapsHyperlink.textContent = ""
    mapsHyperlink.setAttribute('href', "")
}

window.addEventListener('DOMContentLoaded', () => {
    loadParkInfo()
    loadLastPosition()
})



    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

</html>