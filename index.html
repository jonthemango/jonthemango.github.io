<!doctype html>
<html>
    <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    </head>
    <body>
<div class="card">
  <div class="card-body">
        <h5 class="card-title">Park Info</h5>
        <p class="card-text" id="parkTime"></p>
        <p class="card-test" id="parkSide"></span>
        <p class="card-text" id="parkNoPark"></p>
        <p class="card-text" id="parkChangeOn"></p>
        <a class="card-link" target="_blank" id="mapsLink"></a>
  </div>
</div>
<div class="row">
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Left</h5>
        <button type="button" class="btn btn-primary" onclick="park('L')">Left (no park friday)</button>
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Right</h5>
        <button type="button" class="btn btn-primary" onclick="park('R')">Right (no park thursday)</button>
      </div>
    </div>
  </div>
</div>

        

    </body>
    <script>




function storeInBrowser(key, obj) {
  if (typeof key !== 'string') {
    throw new Error('Key must be a string');
  }
  try {
    const serialized = JSON.stringify(obj);
    localStorage.setItem(key, serialized);
  } catch (e) {
    console.error('Failed to store object:', e);
  }
}

function getFromBrowser(key) {
  try {
    const serialized = localStorage.getItem(key);
    return serialized ? JSON.parse(serialized) : null;
  } catch (e) {
    console.error('Failed to retrieve object:', e);
    return null;
  }
}

function getLocalDateTime() {
  const now = new Date();
  return now.toLocaleString(); // e.g., "03/08/2025, 11:42:10 PM"
}

async function getCurrentPositionAsync() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("Geolocation is not supported"));
    } else {
      navigator.geolocation.getCurrentPosition(resolve, reject);
    }
  });
}

async function getCurrentPosition() {
    if ("geolocation" in navigator) {
        const position = await getCurrentPositionAsync();
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`
        let retval = {latitude, longitude, mapsLink}
        return retval
    } else {
        // Geolocation is not supported by this browser
        console.error("Geolocation is not supported by your browser.");
    }
}

async function park(side) {
    let pos = await getCurrentPosition()
    let time = getLocalDateTime()
    console.log(pos)
    storeInBrowser("lastPark", {
        pos,
        time,
        side
    })
    setTimeout(load, 100)
}


/**
 * @param {Date|string} parkedDate - Date you parked
 * @param {string|string[]} noParkingDays - Day(s) of week you must move by (e.g. "Thursday", or ["Thursday", "Friday"])
 * @param {Date|string} [currentDate=new Date()] - Current date, optional, defaults to now
 * @returns {string} - The day of the week you need to change your parking
 */
function getParkingChangeDay(parkedDate, noParkingDays, currentDate = new Date()) {
  const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

  const parked = new Date(parkedDate);
  const current = new Date(currentDate);

  const noParkDays = Array.isArray(noParkingDays) ? noParkingDays : [noParkingDays];
  const noParkDayNums = noParkDays.map(day => daysOfWeek.indexOf(day));

  if (noParkDayNums.some(d => d === -1)) {
    throw new Error("Invalid day name in noParkingDays");
  }

  let dayToCheck = parked.getDay();

  for (let i = 1; i <= 7; i++) {
    const nextDay = (dayToCheck + i) % 7;
    if (noParkDayNums.includes(nextDay)) {
      const changeDate = new Date(parked);
      changeDate.setDate(parked.getDate() + i);

      if (changeDate >= current) {
        // Return the day BEFORE the no-parking day
        const dayBefore = (nextDay + 6) % 7; // previous day (mod 7)
        return daysOfWeek[dayBefore];
      }
    }
  }

  return null;
}

function load() {
    let sideMap = {"L": "left", "R": "right"}
    let noParkMap = {"L": "Friday", "R": "Thursday"}
    let lastPark = getFromBrowser("lastPark")
    if (lastPark) {
        document.getElementById('parkTime').textContent = `Parked on: ${lastPark.time}`
        document.getElementById('parkSide').textContent = `Side: ${sideMap[lastPark.side]} (no parking on ${noParkMap[lastPark.side]})`
        let mapsHyperlink = document.getElementById('mapsLink')
        mapsHyperlink.textContent = "Find my car"
        mapsHyperlink.setAttribute('href', lastPark.pos.mapsLink)

        let changeDay = getParkingChangeDay(lastPark.time, noParkMap[lastPark.side])
        document.getElementById('parkChangeOn').textContent = `Change parking spot on ${changeDay}`
    }
}

window.addEventListener('DOMContentLoaded', () => {
    load()
})



    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

</html>